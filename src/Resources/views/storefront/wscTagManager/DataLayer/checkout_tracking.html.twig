{# Checkout Tracking - add_payment_info & add_shipping_info Events #}
<script>
(function() {
    'use strict';

    // Set debug mode from backend config
    window.__wscCheckoutDebug = {{ config('WscSwCookieDataLayer.config.wscTagManagerDataLayerDebug') ? 'true' : 'false' }};

    // Only run on checkout pages (improved path check for multi-language support)
    const isCheckoutPage = window.location.pathname.includes('/checkout/') ||
                          window.location.pathname.includes('/checkout') ||
                          window.location.pathname.match(/\/(en|de|fr|it|es|nl)\/checkout/);

    if (!isCheckoutPage) {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Not on checkout page, skipping');
        return;
    }

    if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Initializing on checkout page...');

    const dataLayer = window.dataLayer || [];
    const mtmLayer = window._mtm || [];

    // Check if already initialized (prevent double initialization from plugin)
    if (window.__wscCheckoutTrackingInitialized) {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Already initialized, skipping');
        return;
    }
    window.__wscCheckoutTrackingInitialized = true;

    // Helper: Get cart items and user data from last DataLayer event
    function getCartData() {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Getting cart data from dataLayer...');

        for (let i = dataLayer.length - 1; i >= 0; i--) {
            const entry = dataLayer[i];
            if (entry && entry.ecommerce && entry.ecommerce.items && entry.ecommerce.items.length > 0) {
                if (window.__wscCheckoutDebug) {
                    console.log('üîß WSC Checkout Tracking: Found cart data at index', i, entry);
                }
                return {
                    items: entry.ecommerce.items,
                    value: entry.ecommerce.value || 0,
                    currency: entry.ecommerce.currency || 'EUR',
                    user: entry.user || {} // Include user data from dataLayer
                };
            }
        }

        if (window.__wscCheckoutDebug) console.warn('üîß WSC Checkout Tracking: No cart items found in dataLayer!');
        return null;
    }

    // Helper: Push event to dataLayer and Matomo
    function pushEvent(eventName, ecommerceData, userData) {
        const eventPayload = {
            event: eventName,
            ecommerce: ecommerceData,
            user: userData || {} // Include user data if available
        };

        if (window.__wscCheckoutDebug) {
            console.log('üì§ WSC Checkout Tracking: Pushing event:', eventName, eventPayload);
        }

        if (Array.isArray(dataLayer)) {
            dataLayer.push({ ecommerce: null });
            dataLayer.push(eventPayload);
            if (window.__wscCheckoutDebug) console.log('‚úÖ Pushed to window.dataLayer');
        }

        if (Array.isArray(mtmLayer)) {
            mtmLayer.push({ ecommerce: null });
            mtmLayer.push(eventPayload);
            if (window.__wscCheckoutDebug) console.log('‚úÖ Pushed to window._mtm');
        }
    }

    // Track payment method selection
    let lastPaymentMethod = null;

    function trackPaymentMethodChange() {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: trackPaymentMethodChange() called');

        // Find selected payment method
        const selectedPayment = document.querySelector('input[name="paymentMethodId"]:checked');
        if (!selectedPayment) {
            if (window.__wscCheckoutDebug) console.warn('üîß WSC Checkout Tracking: No payment method selected (selector: input[name="paymentMethodId"]:checked)');
            return;
        }

        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Found selected payment:', selectedPayment);

        const paymentMethodId = selectedPayment.value;

        // Find payment method name from label (only the title, not description)
        let paymentMethodName = paymentMethodId;

        const label = document.querySelector(`label[for="${selectedPayment.id}"]`);
        if (label) {
            // Try to find the payment name element (usually the first strong/span)
            const nameElement = label.querySelector('.payment-method-name, .payment-name, strong, .font-weight-bold');
            if (nameElement) {
                paymentMethodName = nameElement.textContent.trim();
            } else {
                // Fallback: Get first line of text only, remove extra whitespace
                const fullText = label.textContent || '';
                // Split by newline, take first part, remove all extra whitespace
                paymentMethodName = fullText.split('\n')[0].replace(/\s+/g, ' ').trim();
            }
        }

        // Additional cleanup: If text is too long, it probably includes description - take first 50 chars
        if (paymentMethodName.length > 50) {
            paymentMethodName = paymentMethodName.substring(0, 50).trim();
        }

        // Only fire if payment method changed
        if (paymentMethodId === lastPaymentMethod) {
            if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Payment method unchanged, skipping event');
            return;
        }
        lastPaymentMethod = paymentMethodId;

        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Payment method changed to:', paymentMethodName, '(ID:', paymentMethodId, ')');

        const cartData = getCartData();
        if (!cartData) {
            if (window.__wscCheckoutDebug) console.warn('üîß WSC Checkout Tracking: Cannot track payment - no cart data!');
            return;
        }

        pushEvent('add_payment_info', {
            currency: cartData.currency,
            value: cartData.value,
            payment_type: paymentMethodName,
            items: cartData.items
        }, cartData.user);
    }

    // Track shipping method selection
    let lastShippingMethod = null;

    function trackShippingMethodChange() {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: trackShippingMethodChange() called');

        // Find selected shipping method
        const selectedShipping = document.querySelector('input[name="shippingMethodId"]:checked');
        if (!selectedShipping) {
            if (window.__wscCheckoutDebug) console.warn('üîß WSC Checkout Tracking: No shipping method selected (selector: input[name="shippingMethodId"]:checked)');
            return;
        }

        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Found selected shipping:', selectedShipping);

        const shippingMethodId = selectedShipping.value;

        // Find shipping method name from label (only the title, not description)
        let shippingMethodName = shippingMethodId;

        const label = document.querySelector(`label[for="${selectedShipping.id}"]`);
        if (label) {
            // Try to find the shipping name element (usually the first strong/span)
            const nameElement = label.querySelector('.shipping-method-name, .shipping-name, strong, .font-weight-bold');
            if (nameElement) {
                shippingMethodName = nameElement.textContent.trim();
            } else {
                // Fallback: Get first line of text only, remove extra whitespace
                const fullText = label.textContent || '';
                // Split by newline, take first part, remove all extra whitespace
                shippingMethodName = fullText.split('\n')[0].replace(/\s+/g, ' ').trim();
            }
        }

        // Additional cleanup: If text is too long, it probably includes description - take first 50 chars
        if (shippingMethodName.length > 50) {
            shippingMethodName = shippingMethodName.substring(0, 50).trim();
        }

        // Only fire if shipping method changed
        if (shippingMethodId === lastShippingMethod) {
            if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Shipping method unchanged, skipping event');
            return;
        }
        lastShippingMethod = shippingMethodId;

        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Shipping method changed to:', shippingMethodName, '(ID:', shippingMethodId, ')');

        const cartData = getCartData();
        if (!cartData) {
            if (window.__wscCheckoutDebug) console.warn('üîß WSC Checkout Tracking: Cannot track shipping - no cart data!');
            return;
        }

        pushEvent('add_shipping_info', {
            currency: cartData.currency,
            value: cartData.value,
            shipping_tier: shippingMethodName,
            items: cartData.items
        }, cartData.user);
    }

    // Register event listeners
    function registerListeners() {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Registering event listeners...');

        // Listen for payment method changes (radio buttons)
        document.addEventListener('change', function(event) {
            const target = event.target;
            if (target && target.name === 'paymentMethodId') {
                if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Payment method change event detected');
                // Delay to allow UI to update
                setTimeout(trackPaymentMethodChange, 100);
            }
        });

        // Listen for shipping method changes (radio buttons)
        document.addEventListener('change', function(event) {
            const target = event.target;
            if (target && target.name === 'shippingMethodId') {
                if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: Shipping method change event detected');
                // Delay to allow UI to update
                setTimeout(trackShippingMethodChange, 100);
            }
        });

        if (window.__wscCheckoutDebug) {
            console.log('üîß WSC Checkout Tracking: Change listeners registered');
            // Debug: Check if inputs exist on page
            const paymentInputs = document.querySelectorAll('input[name="paymentMethodId"]');
            const shippingInputs = document.querySelectorAll('input[name="shippingMethodId"]');
            console.log('üîß WSC Checkout Tracking: Found', paymentInputs.length, 'payment inputs');
            console.log('üîß WSC Checkout Tracking: Found', shippingInputs.length, 'shipping inputs');
        }

        // IMPORTANT: DO NOT auto-track on page load!
        // This would cause duplicate events when begin_checkout fires.
        // Events should only be tracked when the user MANUALLY changes the selection.

        if (window.__wscCheckoutDebug) {
            console.log('‚ö†Ô∏è WSC Checkout Tracking: Auto-tracking on page load is DISABLED');
            console.log('   Reason: Prevents duplicate events with begin_checkout');
            console.log('   Events will only fire when user manually changes payment/shipping method');
        }
    }

    // Initialize
    if (document.readyState === 'loading') {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: DOM still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: DOMContentLoaded fired, registering listeners');
            registerListeners();
        });
    } else {
        if (window.__wscCheckoutDebug) console.log('üîß WSC Checkout Tracking: DOM already loaded, registering listeners immediately');
        registerListeners();
    }

    if (window.__wscCheckoutDebug) console.log('‚úÖ WSC Checkout Tracking: Initialization complete!');
})();
</script>
