{# Promotion Event Tracking - view_promotion & select_promotion #}
<script>
(function() {
    'use strict';

    if (window.__wscDebugMode) console.log('ðŸ”§ WSC Promotion Tracking: Loading...');

    // Check if already initialized
    if (window.__wscPromotionTrackerInitialized) {
        if (window.__wscDebugMode) console.log('ðŸ”§ WSC Promotion Tracking: Already initialized, skipping');
        return;
    }
    window.__wscPromotionTrackerInitialized = true;

    const dataLayer = window.dataLayer || [];
    const mtmLayer = window._mtm || [];

    // Track which promotions have been viewed (to avoid duplicates)
    const viewedPromotions = new Set();

    /**
     * Extract promotion data from element
     * Supports two types:
     * 1. Content promotions (banners without products)
     * 2. Product promotions (sliders with products)
     */
    function getPromotionData(element) {
        if (window.__wscDebugMode) console.log('ðŸ”§ Extracting promotion data from:', element);

        // Basic promotion info (for both types)
        const promotionId = element.getAttribute('data-promotion-id') ||
                           element.getAttribute('data-banner-id') ||
                           element.id ||
                           'promotion_' + Math.random().toString(36).substr(2, 9);

        const promotionName = element.getAttribute('data-promotion-name') ||
                             element.getAttribute('data-banner-name') ||
                             element.getAttribute('title') ||
                             element.getAttribute('alt') ||
                             'Unknown Promotion';

        const creativeName = element.getAttribute('data-creative-name') ||
                            element.getAttribute('data-banner-creative') ||
                            promotionName;

        const creativeSlot = element.getAttribute('data-creative-slot') ||
                            element.getAttribute('data-banner-slot') ||
                            'unknown_slot';

        const basePromotionData = {
            promotion_id: promotionId,
            promotion_name: promotionName,
            creative_name: creativeName,
            creative_slot: creativeSlot
        };

        // Check if this is a PRODUCT promotion (slider with products)
        const productElements = element.querySelectorAll('[data-product-info]');

        if (productElements.length > 0) {
            // This is a PRODUCT PROMOTION (e.g., "Best Sellers", "Sale Products")
            if (window.__wscDebugMode) console.log('ðŸ”§ Product promotion detected with', productElements.length, 'products');

            const items = [];
            productElements.forEach(function(productEl) {
                try {
                    const productJson = productEl.getAttribute('data-product-info');
                    if (!productJson) return;

                    const productData = JSON.parse(productJson);

                    // Add promotion info to product data
                    productData.promotion_id = promotionId;
                    productData.promotion_name = promotionName;
                    productData.creative_name = creativeName;
                    productData.creative_slot = creativeSlot;

                    items.push(productData);
                } catch (e) {
                    if (window.__wscDebugMode) console.warn('ðŸ”§ Failed to parse product data in promotion:', e);
                }
            });

            return {
                type: 'product_promotion',
                items: items,
                promotion_info: basePromotionData
            };
        } else {
            // This is a CONTENT PROMOTION (banner without products)
            if (window.__wscDebugMode) console.log('ðŸ”§ Content promotion detected (no products)');

            return {
                type: 'content_promotion',
                items: [basePromotionData],
                promotion_info: basePromotionData
            };
        }
    }

    /**
     * Push promotion event to dataLayer and mtmLayer
     */
    function pushPromotionEvent(eventName, promotionDataResult) {
        // promotionDataResult can be either:
        // - {type: 'product_promotion', items: [...products...], promotion_info: {...}}
        // - {type: 'content_promotion', items: [{promotion_id, ...}], promotion_info: {...}}

        const eventData = {
            event: eventName,
            ecommerce: {
                items: promotionDataResult.items
            }
        };

        // Add promotion_id and promotion_name to top level for easier filtering in GA4
        if (promotionDataResult.promotion_info) {
            eventData.ecommerce.promotion_id = promotionDataResult.promotion_info.promotion_id;
            eventData.ecommerce.promotion_name = promotionDataResult.promotion_info.promotion_name;
        }

        // Push to Google Analytics / GTM
        if (Array.isArray(dataLayer)) {
            dataLayer.push({ ecommerce: null }); // Clear previous ecommerce data
            dataLayer.push(eventData);
        }

        // Push to Matomo
        if (Array.isArray(mtmLayer)) {
            mtmLayer.push({ ecommerce: null });
            mtmLayer.push(eventData);
        }

        if (window.__wscDebugMode) {
            console.log('ðŸŽ¨ WSC Promotion Event pushed:', eventName, promotionDataResult.type, eventData);
            console.log('   Items:', promotionDataResult.items.length, promotionDataResult.type === 'product_promotion' ? 'products' : 'promotion');
        }
    }

    /**
     * Register view_promotion listener (using Intersection Observer)
     */
    function registerViewPromotionListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering view_promotion listener');

        // Check if Intersection Observer is supported
        if (!('IntersectionObserver' in window)) {
            if (window.__wscDebugMode) console.warn('ðŸ”§ IntersectionObserver not supported, view_promotion tracking disabled');
            return;
        }

        // Find all promotion elements
        const promotionSelectors = [
            '[data-promotion-tracking]',
            '[data-banner-tracking]',
            '.promotion-banner',
            '.cms-element-image-slider[data-promotion="true"]',
            '.banner-slider[data-promotion="true"]'
        ];

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                // Element is visible (at least 50% in viewport)
                if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                    const element = entry.target;
                    const promotionData = getPromotionData(element);
                    const uniqueKey = promotionData.promotion_id;

                    // Check if already viewed
                    if (viewedPromotions.has(uniqueKey)) {
                        if (window.__wscDebugMode) console.log('ðŸ”§ Promotion already viewed, skipping:', uniqueKey);
                        return;
                    }

                    // Mark as viewed
                    viewedPromotions.add(uniqueKey);

                    if (window.__wscDebugMode) console.log('ðŸ”§ Promotion viewed:', promotionData);

                    pushPromotionEvent('view_promotion', promotionData);

                    // Stop observing this element (it's been viewed)
                    observer.unobserve(element);
                }
            });
        }, {
            threshold: 0.5 // Trigger when 50% of the element is visible
        });

        // Observe all promotion elements
        const promotionElements = document.querySelectorAll(promotionSelectors.join(', '));

        if (promotionElements.length === 0) {
            if (window.__wscDebugMode) console.log('ðŸ”§ No promotion elements found on this page');
            return;
        }

        if (window.__wscDebugMode) console.log('ðŸ”§ Found', promotionElements.length, 'promotion elements to track');

        promotionElements.forEach(function(element) {
            observer.observe(element);
        });

        // ALSO observe product sliders that might be promotions but don't have explicit data-promotion-tracking
        // Look for product sliders with specific CMS element classes
        const productSliders = document.querySelectorAll('.cms-element-product-slider, .product-slider, .product-carousel');
        productSliders.forEach(function(slider) {
            // Check if slider has products with data-product-info
            if (slider.querySelectorAll('[data-product-info]').length > 0) {
                // Add a default promotion tracking attribute if not set
                if (!slider.hasAttribute('data-promotion-tracking') && !slider.hasAttribute('data-banner-tracking')) {
                    slider.setAttribute('data-promotion-tracking', 'auto');
                    // Try to extract name from heading
                    const heading = slider.querySelector('h2, h3, .cms-element-product-slider-title, .slider-title');
                    if (heading) {
                        slider.setAttribute('data-promotion-name', heading.textContent.trim());
                    }
                    observer.observe(slider);
                    if (window.__wscDebugMode) console.log('ðŸ”§ Auto-detected product slider as promotion:', slider);
                }
            }
        });
    }

    /**
     * Register select_promotion listener (click tracking)
     */
    function registerSelectPromotionListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering select_promotion listener');

        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            // Find promotion element (banner or product slider)
            const promotionElement = target.closest(
                '[data-promotion-tracking], [data-banner-tracking], .promotion-banner, .banner-link[data-promotion="true"], .cms-element-product-slider, .product-slider, .product-carousel'
            );

            if (!promotionElement) return;

            // Check if this is a product click within a promotion (product slider)
            const clickedProduct = target.closest('[data-product-info]');

            if (clickedProduct) {
                // User clicked a specific product in the promotion/slider
                if (window.__wscDebugMode) console.log('ðŸ”§ Product clicked in promotion:', clickedProduct);

                try {
                    const productJson = clickedProduct.getAttribute('data-product-info');
                    if (!productJson) return;

                    const productData = JSON.parse(productJson);

                    // Add promotion info to the product
                    const promotionId = promotionElement.getAttribute('data-promotion-id') ||
                                       promotionElement.getAttribute('data-promotion-name') ||
                                       'product_slider';
                    const promotionName = promotionElement.getAttribute('data-promotion-name') || 'Product Slider';

                    productData.promotion_id = promotionId;
                    productData.promotion_name = promotionName;
                    productData.creative_name = promotionElement.getAttribute('data-creative-name') || promotionName;
                    productData.creative_slot = promotionElement.getAttribute('data-creative-slot') || 'unknown';

                    if (window.__wscDebugMode) console.log('ðŸ”§ Pushing select_promotion event for product:', productData);

                    pushPromotionEvent('select_promotion', {
                        type: 'product_promotion',
                        items: [productData],
                        promotion_info: {
                            promotion_id: promotionId,
                            promotion_name: promotionName
                        }
                    });

                } catch (e) {
                    if (window.__wscDebugMode) console.warn('ðŸ”§ Failed to parse product in promotion:', e);
                }

            } else {
                // User clicked the promotion banner itself (not a specific product)
                if (window.__wscDebugMode) console.log('ðŸ”§ Promotion banner clicked:', promotionElement);

                const promotionData = getPromotionData(promotionElement);

                if (window.__wscDebugMode) console.log('ðŸ”§ Pushing select_promotion event:', promotionData);

                pushPromotionEvent('select_promotion', promotionData);
            }
        }, true);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM is still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__wscDebugMode) console.log('ðŸ”§ DOMContentLoaded fired, initializing promotion listeners...');
            registerViewPromotionListener();
            registerSelectPromotionListener();
            if (window.__wscDebugMode) console.log('âœ… WSC Promotion listeners registered successfully!');
        });
    } else {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM already loaded, initializing promotion listeners immediately...');
        registerViewPromotionListener();
        registerSelectPromotionListener();
        if (window.__wscDebugMode) console.log('âœ… WSC Promotion listeners registered successfully!');
    }
})();
</script>
