{# Promotion Event Tracking - view_promotion & select_promotion #}
<script>
(function() {
    'use strict';

    if (window.__wscDebugMode) console.log('ðŸ”§ WSC Promotion Tracking: Loading...');

    // Check if already initialized
    if (window.__wscPromotionTrackerInitialized) {
        if (window.__wscDebugMode) console.log('ðŸ”§ WSC Promotion Tracking: Already initialized, skipping');
        return;
    }
    window.__wscPromotionTrackerInitialized = true;

    const dataLayer = window.dataLayer || [];
    const mtmLayer = window._mtm || [];

    // Track which promotions have been viewed (to avoid duplicates)
    const viewedPromotions = new Set();

    /**
     * Parse BEM-style CSS class for promotion info
     * Example: "datalayer-promotion-slider--bestseller"
     * Returns: {type: 'slider', identifier: 'bestseller'}
     */
    function parsePromotionClass(element) {
        const classList = element.classList;
        for (let i = 0; i < classList.length; i++) {
            const className = classList[i];

            // Check for datalayer-promotion-* pattern
            if (className.startsWith('datalayer-promotion-')) {
                const parts = className.replace('datalayer-promotion-', '').split('--');
                return {
                    type: parts[0], // e.g., 'slider', 'banner'
                    identifier: parts[1] || null, // e.g., 'bestseller', 'adventskalender'
                    fullClass: className
                };
            }
        }
        return null;
    }

    /**
     * Extract promotion data from element
     * Supports two types:
     * 1. Content promotions (banners without products)
     * 2. Product promotions (sliders with products)
     *
     * NEW: Primary detection via CSS classes (datalayer-promotion-{type}--{identifier})
     */
    function getPromotionData(element) {
        if (window.__wscDebugMode) console.log('ðŸ”§ Extracting promotion data from:', element);

        // PRIMARY: Parse CSS class (BEM syntax: datalayer-promotion-{type}--{identifier})
        const cssInfo = parsePromotionClass(element);

        // Build promotion info with fallbacks
        let promotionId = element.getAttribute('data-promotion-id') ||
                         element.getAttribute('data-banner-id');

        let promotionName = element.getAttribute('data-promotion-name') ||
                           element.getAttribute('data-banner-name');

        let promotionType = element.getAttribute('data-promotion-type');

        // Use CSS class info if available
        if (cssInfo) {
            if (window.__wscDebugMode) console.log('ðŸ”§ Found promotion CSS class:', cssInfo);

            if (!promotionId && cssInfo.identifier) {
                promotionId = cssInfo.identifier; // e.g., 'bestseller', 'adventskalender'
            }
            if (!promotionName && cssInfo.identifier) {
                // Beautify identifier: 'bestseller' -> 'Bestseller', 'adventskalender' -> 'Adventskalender'
                promotionName = cssInfo.identifier.charAt(0).toUpperCase() + cssInfo.identifier.slice(1);
            }
            if (!promotionType) {
                promotionType = cssInfo.type; // e.g., 'slider', 'banner'
            }
        }

        // Final fallbacks
        if (!promotionId) {
            promotionId = element.id || 'promotion_' + Math.random().toString(36).substr(2, 9);
        }
        if (!promotionName) {
            promotionName = element.getAttribute('title') ||
                           element.getAttribute('alt') ||
                           'Unknown Promotion';
        }

        const creativeName = element.getAttribute('data-creative-name') ||
                            element.getAttribute('data-banner-creative') ||
                            promotionName;

        const creativeSlot = element.getAttribute('data-creative-slot') ||
                            element.getAttribute('data-banner-slot') ||
                            (promotionType ? promotionType + '_slot' : 'unknown_slot');

        const basePromotionData = {
            promotion_id: promotionId,
            promotion_name: promotionName,
            creative_name: creativeName,
            creative_slot: creativeSlot
        };

        // Check if this is a PRODUCT promotion (slider with products)
        const productElements = element.querySelectorAll('[data-product-info]');

        if (productElements.length > 0) {
            // This is a PRODUCT PROMOTION (e.g., "Best Sellers", "Sale Products")
            if (window.__wscDebugMode) console.log('ðŸ”§ Product promotion detected with', productElements.length, 'products');

            const items = [];
            productElements.forEach(function(productEl) {
                try {
                    const productJson = productEl.getAttribute('data-product-info');
                    if (!productJson) return;

                    const productData = JSON.parse(productJson);

                    // Add promotion info to product data
                    productData.promotion_id = promotionId;
                    productData.promotion_name = promotionName;
                    productData.creative_name = creativeName;
                    productData.creative_slot = creativeSlot;

                    items.push(productData);
                } catch (e) {
                    if (window.__wscDebugMode) console.warn('ðŸ”§ Failed to parse product data in promotion:', e);
                }
            });

            return {
                type: 'product_promotion',
                items: items,
                promotion_info: basePromotionData
            };
        } else {
            // This is a CONTENT PROMOTION (banner without products)
            if (window.__wscDebugMode) console.log('ðŸ”§ Content promotion detected (no products)');

            return {
                type: 'content_promotion',
                items: [basePromotionData],
                promotion_info: basePromotionData
            };
        }
    }

    /**
     * Push promotion event to dataLayer and mtmLayer
     */
    function pushPromotionEvent(eventName, promotionDataResult) {
        // promotionDataResult can be either:
        // - {type: 'product_promotion', items: [...products...], promotion_info: {...}}
        // - {type: 'content_promotion', items: [{promotion_id, ...}], promotion_info: {...}}

        const eventData = {
            event: eventName,
            ecommerce: {
                items: promotionDataResult.items
            }
        };

        // Add promotion_id and promotion_name to top level for easier filtering in GA4
        if (promotionDataResult.promotion_info) {
            eventData.ecommerce.promotion_id = promotionDataResult.promotion_info.promotion_id;
            eventData.ecommerce.promotion_name = promotionDataResult.promotion_info.promotion_name;
        }

        // Push to Google Analytics / GTM
        if (Array.isArray(dataLayer)) {
            dataLayer.push({ ecommerce: null }); // Clear previous ecommerce data
            dataLayer.push(eventData);
        }

        // Push to Matomo
        if (Array.isArray(mtmLayer)) {
            mtmLayer.push({ ecommerce: null });
            mtmLayer.push(eventData);
        }

        if (window.__wscDebugMode) {
            console.log('ðŸŽ¨ WSC Promotion Event pushed:', eventName, promotionDataResult.type, eventData);
            console.log('   Items:', promotionDataResult.items.length, promotionDataResult.type === 'product_promotion' ? 'products' : 'promotion');
        }
    }

    /**
     * Register view_promotion listener (using Intersection Observer)
     */
    function registerViewPromotionListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering view_promotion listener');

        // Check if Intersection Observer is supported
        if (!('IntersectionObserver' in window)) {
            if (window.__wscDebugMode) console.warn('ðŸ”§ IntersectionObserver not supported, view_promotion tracking disabled');
            return;
        }

        // Find all promotion elements
        // PRIMARY: CSS class convention (datalayer-promotion-*)
        // FALLBACK: Old data-attribute method
        const promotionSelectors = [
            '[class*="datalayer-promotion-"]',  // PRIMARY: CSS class convention (NEW!)
            '[data-promotion-tracking]',         // Fallback: explicit attribute
            '[data-banner-tracking]',            // Fallback: banner attribute
            '.promotion-banner',                 // Fallback: generic class
            '.cms-element-image-slider[data-promotion="true"]', // Fallback: specific CMS
            '.banner-slider[data-promotion="true"]'             // Fallback: banner slider
        ];

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                // Element is visible (at least 50% in viewport)
                if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                    const element = entry.target;
                    const promotionData = getPromotionData(element);
                    const uniqueKey = promotionData.promotion_id;

                    // Check if already viewed
                    if (viewedPromotions.has(uniqueKey)) {
                        if (window.__wscDebugMode) console.log('ðŸ”§ Promotion already viewed, skipping:', uniqueKey);
                        return;
                    }

                    // Mark as viewed
                    viewedPromotions.add(uniqueKey);

                    if (window.__wscDebugMode) console.log('ðŸ”§ Promotion viewed:', promotionData);

                    pushPromotionEvent('view_promotion', promotionData);

                    // Stop observing this element (it's been viewed)
                    observer.unobserve(element);
                }
            });
        }, {
            threshold: 0.5 // Trigger when 50% of the element is visible
        });

        // Observe all promotion elements
        const promotionElements = document.querySelectorAll(promotionSelectors.join(', '));

        if (promotionElements.length === 0) {
            if (window.__wscDebugMode) console.log('ðŸ”§ No promotion elements found on this page');
            return;
        }

        if (window.__wscDebugMode) console.log('ðŸ”§ Found', promotionElements.length, 'promotion elements to track');

        promotionElements.forEach(function(element) {
            observer.observe(element);
        });

        // NOTE: Auto-detection of generic sliders is DISABLED by default
        // Use CSS class convention (datalayer-promotion-slider) instead!
        // This prevents false positives (cross-selling, related products, etc.)
        if (window.__wscDebugMode) {
            console.log('ðŸ’¡ TIP: Use CSS class "datalayer-promotion-slider--{name}" to mark sliders as promotions');
            console.log('ðŸ’¡ TIP: Use CSS class "datalayer-promotion-banner--{name}" to mark banners as promotions');
        }
    }

    /**
     * Register select_promotion listener (click tracking)
     */
    function registerSelectPromotionListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering select_promotion listener');

        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            // Find promotion element (banner or product slider)
            // PRIMARY: CSS class convention
            const promotionElement = target.closest(
                '[class*="datalayer-promotion-"], [data-promotion-tracking], [data-banner-tracking], .promotion-banner'
            );

            if (!promotionElement) return;

            // Check if this is a product click within a promotion (product slider)
            const clickedProduct = target.closest('[data-product-info]');

            if (clickedProduct) {
                // User clicked a specific product in the promotion/slider
                if (window.__wscDebugMode) console.log('ðŸ”§ Product clicked in promotion:', clickedProduct);

                try {
                    const productJson = clickedProduct.getAttribute('data-product-info');
                    if (!productJson) return;

                    const productData = JSON.parse(productJson);

                    // Add promotion info to the product
                    // PRIMARY: Parse CSS class (BEM syntax: datalayer-promotion-{type}--{identifier})
                    const cssInfo = parsePromotionClass(promotionElement);

                    let promotionId = promotionElement.getAttribute('data-promotion-id') ||
                                     promotionElement.getAttribute('data-promotion-name');
                    let promotionName = promotionElement.getAttribute('data-promotion-name');
                    let promotionType = promotionElement.getAttribute('data-promotion-type');

                    // Use CSS class info if available
                    if (cssInfo) {
                        if (window.__wscDebugMode) console.log('ðŸ”§ Found promotion CSS class on click:', cssInfo);

                        if (!promotionId && cssInfo.identifier) {
                            promotionId = cssInfo.identifier; // e.g., 'bestseller', 'adventskalender'
                        }
                        if (!promotionName && cssInfo.identifier) {
                            // Beautify identifier: 'bestseller' -> 'Bestseller'
                            promotionName = cssInfo.identifier.charAt(0).toUpperCase() + cssInfo.identifier.slice(1);
                        }
                        if (!promotionType) {
                            promotionType = cssInfo.type; // e.g., 'slider', 'banner'
                        }
                    }

                    // Final fallbacks
                    if (!promotionId) promotionId = 'product_slider';
                    if (!promotionName) promotionName = 'Product Slider';

                    productData.promotion_id = promotionId;
                    productData.promotion_name = promotionName;
                    productData.creative_name = promotionElement.getAttribute('data-creative-name') || promotionName;
                    productData.creative_slot = promotionElement.getAttribute('data-creative-slot') ||
                                               (promotionType ? promotionType + '_slot' : 'unknown');

                    if (window.__wscDebugMode) console.log('ðŸ”§ Pushing select_promotion event for product:', productData);

                    pushPromotionEvent('select_promotion', {
                        type: 'product_promotion',
                        items: [productData],
                        promotion_info: {
                            promotion_id: promotionId,
                            promotion_name: promotionName
                        }
                    });

                } catch (e) {
                    if (window.__wscDebugMode) console.warn('ðŸ”§ Failed to parse product in promotion:', e);
                }

            } else {
                // User clicked the promotion banner itself (not a specific product)
                if (window.__wscDebugMode) console.log('ðŸ”§ Promotion banner clicked:', promotionElement);

                const promotionData = getPromotionData(promotionElement);

                if (window.__wscDebugMode) console.log('ðŸ”§ Pushing select_promotion event:', promotionData);

                pushPromotionEvent('select_promotion', promotionData);
            }
        }, true);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM is still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__wscDebugMode) console.log('ðŸ”§ DOMContentLoaded fired, initializing promotion listeners...');
            registerViewPromotionListener();
            registerSelectPromotionListener();
            if (window.__wscDebugMode) console.log('âœ… WSC Promotion listeners registered successfully!');
        });
    } else {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM already loaded, initializing promotion listeners immediately...');
        registerViewPromotionListener();
        registerSelectPromotionListener();
        if (window.__wscDebugMode) console.log('âœ… WSC Promotion listeners registered successfully!');
    }
})();
</script>
