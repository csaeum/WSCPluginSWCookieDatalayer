{# Search Event Tracking #}
<script>
(function() {
    'use strict';

    // Set debug mode from backend config (if not already set)
    if (typeof window.__wscDebugMode === 'undefined') {
        window.__wscDebugMode = {{ config('WscSwCookieDataLayer.config.wscTagManagerDataLayerDebug') ? 'true' : 'false' }};
    }

    if (window.__wscDebugMode) console.log('ğŸ”§ WSC Search Tracking: Loading...');

    // Check if already initialized
    if (window.__wscSearchTrackerInitialized) {
        if (window.__wscDebugMode) console.log('ğŸ”§ WSC Search Tracking: Already initialized, skipping');
        return;
    }
    window.__wscSearchTrackerInitialized = true;

    const dataLayer = window.dataLayer || [];
    const mtmLayer = window._mtm || [];

    /**
     * Get user data from existing dataLayer entries
     */
    function getUserData() {
        if (window.__wscDebugMode) console.log('ğŸ”§ WSC Search: Getting user data from dataLayer...');

        for (let i = dataLayer.length - 1; i >= 0; i--) {
            const entry = dataLayer[i];
            if (entry && entry.user && Object.keys(entry.user).length > 0) {
                if (window.__wscDebugMode) {
                    console.log('ğŸ”§ WSC Search: Found user data at index', i, entry.user);
                }
                return entry.user;
            }
        }

        if (window.__wscDebugMode) console.log('ğŸ”§ WSC Search: No user data found in dataLayer');
        return {}; // Empty object for guest users
    }

    /**
     * Push view_search_results event to dataLayer and mtmLayer
     * GA4 Standard: view_search_results (not "search")
     */
    function pushSearchEvent(searchTerm) {
        const userData = getUserData();

        const eventData = {
            event: 'view_search_results',  // GA4 Standard event name
            search_term: searchTerm,
            user: userData // Include user data
        };

        if (window.__wscDebugMode) {
            console.log('ğŸ” WSC view_search_results Event pushing:', eventData);
        }

        // Push to Google Analytics / GTM
        if (Array.isArray(dataLayer)) {
            dataLayer.push(eventData);
        }

        // Push to Matomo
        if (Array.isArray(mtmLayer)) {
            mtmLayer.push(eventData);
        }

        if (window.__wscDebugMode) {
            console.log('âœ… WSC view_search_results Event pushed successfully');
        }
    }

    /**
     * Get search term from URL
     */
    function getSearchTermFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('search') || urlParams.get('q') || '';
    }

    /**
     * Check if we're on a search results page and fire event
     */
    function checkSearchResultsPage() {
        // Check if URL contains /search or is search results page
        const isSearchPage = window.location.pathname.includes('/search');

        if (!isSearchPage) {
            if (window.__wscDebugMode) console.log('ğŸ”§ Not a search results page');
            return;
        }

        // Get search term from URL
        const searchTerm = getSearchTermFromURL();
        if (!searchTerm) {
            if (window.__wscDebugMode) console.warn('ğŸ”§ Search results page but no search term in URL');
            return;
        }

        // Check if we already fired this search term (prevent duplicates)
        const lastSearchTerm = sessionStorage.getItem('wsc_last_search_term');
        if (lastSearchTerm === searchTerm) {
            if (window.__wscDebugMode) console.log('ğŸ”§ view_search_results already fired for this search term');
            return;
        }

        if (window.__wscDebugMode) console.log('ğŸ”§ Search results page detected! Term:', searchTerm);

        pushSearchEvent(searchTerm);

        // Store last search term
        sessionStorage.setItem('wsc_last_search_term', searchTerm);
    }

    /**
     * Register search form listener
     */
    function registerSearchListener() {
        if (window.__wscDebugMode) console.log('ğŸ”§ Registering search form listener');

        // Listen for search form submissions
        document.addEventListener('submit', function(event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;

            // Check if it's a search form
            const isSearchForm = form.classList.contains('search-form') ||
                                form.classList.contains('header-search-form') ||
                                form.action.includes('/search') ||
                                form.querySelector('input[name="search"]');

            if (!isSearchForm) return;

            // Get search term
            const searchInput = form.querySelector('input[type="search"], input[name="search"]');
            if (!searchInput) {
                if (window.__wscDebugMode) console.warn('ğŸ”§ Search form found but no search input field');
                return;
            }

            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                if (window.__wscDebugMode) console.warn('ğŸ”§ Search submitted with empty search term');
                return;
            }

            if (window.__wscDebugMode) console.log('ğŸ”§ Search form submitted with term:', searchTerm);

            pushSearchEvent(searchTerm);

            // Store search term for duplicate prevention
            sessionStorage.setItem('wsc_last_search_term', searchTerm);
        }, true);
    }

    /**
     * Register live search (autocomplete) click listener for select_item
     */
    function registerLiveSearchListener() {
        if (window.__wscDebugMode) console.log('ğŸ”§ Registering live search click listener');

        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            // Find if click is inside search suggest/autocomplete dropdown
            const searchSuggestItem = target.closest(
                '.search-suggest-product, .search-suggest-product-link, [data-search-suggest-link], .search-result-item, .search-suggest-container a'
            );

            if (!searchSuggestItem) return;

            if (window.__wscDebugMode) console.log('ğŸ”§ Live search item clicked!', searchSuggestItem);

            // Get search term from active search input
            const searchInput = document.querySelector('input[type="search"], input[name="search"]');
            const searchTerm = searchInput ? searchInput.value.trim() : '';

            if (searchTerm) {
                if (window.__wscDebugMode) console.log('ğŸ”§ Pushing view_search_results for live search term:', searchTerm);

                // Fire view_search_results when clicking item from live search
                pushSearchEvent(searchTerm);

                // Store to prevent duplicate
                sessionStorage.setItem('wsc_last_search_term', searchTerm);
            }

            // Note: select_item event is already handled by add_to_cart.html.twig â†’ registerSelectItemListener()
        }, true);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        if (window.__wscDebugMode) console.log('ğŸ”§ DOM is still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__wscDebugMode) console.log('ğŸ”§ DOMContentLoaded fired, initializing search tracking...');
            checkSearchResultsPage();
            registerSearchListener();
            registerLiveSearchListener();
            if (window.__wscDebugMode) console.log('âœ… WSC Search tracking initialized successfully!');
        });
    } else {
        if (window.__wscDebugMode) console.log('ğŸ”§ DOM already loaded, initializing search tracking immediately...');
        checkSearchResultsPage();
        registerSearchListener();
        registerLiveSearchListener();
        if (window.__wscDebugMode) console.log('âœ… WSC Search tracking initialized successfully!');
    }
})();
</script>
