{# Add to Cart Event Tracking - Simplified with Backend Data #}
<script>
(function() {
    'use strict';

    // Set debug mode from backend config
    window.__wscDebugMode = {{ config('WscSwCookieDataLayer.config.wscTagManagerDataLayerDebug') ? 'true' : 'false' }};

    if (window.__wscDebugMode) console.log('ðŸ”§ WSC Add-to-Cart Script: Loading...');

    // Check if already initialized
    if (window.__wscCartTrackerInitialized) {
        if (window.__wscDebugMode) console.log('ðŸ”§ WSC Add-to-Cart Script: Already initialized, skipping');
        return;
    }
    window.__wscCartTrackerInitialized = true;
    if (window.__wscDebugMode) console.log('ðŸ”§ WSC Add-to-Cart Script: Initialized');

    const dataLayer = window.dataLayer || [];
    const mtmLayer = window._mtm || [];

    // Store last clicked product for fallback
    let lastClickedProduct = null;

    /**
     * Get product data from data-product-info attribute
     */
    function getProductDataFromElement(element) {
        if (window.__wscDebugMode) console.log('ðŸ”§ Getting product data from element:', element);

        const container = element.closest('[data-product-info], .product-box, .product-detail, .buy-widget');
        if (window.__wscDebugMode) console.log('ðŸ”§ Found container:', container);

        let dataEl = null;

        // Try to find data-product-info in the container or its children
        if (container) {
            dataEl = container.querySelector('[data-product-info]') || (container.hasAttribute('data-product-info') ? container : null);
            if (window.__wscDebugMode) console.log('ðŸ”§ Found data element in container:', dataEl);
        }

        // Fallback: Search globally for .wsc-product-data-container (for product detail page)
        if (!dataEl) {
            if (window.__wscDebugMode) console.log('ðŸ”§ No data element in container, searching globally for .wsc-product-data-container');
            dataEl = document.querySelector('.wsc-product-data-container[data-product-info]');
            if (window.__wscDebugMode) console.log('ðŸ”§ Found global data element:', dataEl);
        }

        // Fallback: Search globally for any [data-product-info] (last resort)
        if (!dataEl) {
            if (window.__wscDebugMode) console.log('ðŸ”§ No .wsc-product-data-container found, searching for any [data-product-info]');
            dataEl = document.querySelector('[data-product-info]');
            if (window.__wscDebugMode) console.log('ðŸ”§ Found any data element:', dataEl);
        }

        if (!dataEl) {
            if (window.__wscDebugMode) console.warn('ðŸ”§ No data-product-info element found anywhere');
            return null;
        }

        const dataJson = dataEl.getAttribute('data-product-info');
        if (window.__wscDebugMode) console.log('ðŸ”§ data-product-info JSON:', dataJson);

        if (!dataJson) {
            if (window.__wscDebugMode) console.warn('ðŸ”§ data-product-info attribute is empty');
            return null;
        }

        try {
            const parsed = JSON.parse(dataJson);
            if (window.__wscDebugMode) console.log('ðŸ”§ Parsed product data:', parsed);
            return parsed;
        } catch (e) {
            if (window.__wscDebugMode) console.error('ðŸ”§ WSC DataLayer: Failed to parse product data', e);
            return null;
        }
    }

    /**
     * Get currency from existing dataLayer entries
     */
    function getCurrency() {
        for (let i = dataLayer.length - 1; i >= 0; i--) {
            const entry = dataLayer[i];
            if (entry && entry.ecommerce && entry.ecommerce.currency) {
                return entry.ecommerce.currency;
            }
        }
        return 'EUR'; // Fallback
    }

    /**
     * Push event to dataLayer and mtmLayer
     */
    function pushEvent(eventName, ecommerceData) {
        const eventData = {
            event: eventName,
            ecommerce: ecommerceData
        };

        // Clear ecommerce object first (Google Best Practice)
        if (Array.isArray(dataLayer)) {
            dataLayer.push({ ecommerce: null });
            dataLayer.push(eventData);
        }

        if (Array.isArray(mtmLayer)) {
            mtmLayer.push({ ecommerce: null });
            mtmLayer.push(eventData);
        }
    }

    /**
     * Calculate value (price * quantity)
     */
    function calculateValue(productData, quantity) {
        if (!productData.price) return 0;
        return productData.price * quantity;
    }

    /**
     * Register click listener for add-to-cart buttons
     */
    function registerAddToCartListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering click listener for add-to-cart buttons');

        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            const button = target.closest('.btn-buy, [data-add-to-cart], button[data-product-id]');
            if (!button) return;

            if (window.__wscDebugMode) console.log('ðŸ”§ Add-to-cart button clicked!', button);

            const productData = getProductDataFromElement(button);
            if (!productData || !productData.item_id) {
                if (window.__wscDebugMode) console.warn('ðŸ”§ No valid product data found on click');
                return;
            }

            // Store for potential AJAX fallback
            lastClickedProduct = productData;
            if (window.__wscDebugMode) console.log('ðŸ”§ Stored product data for AJAX request:', lastClickedProduct);
        }, true);
    }

    /**
     * Extract quantity from FormData or request body
     */
    function extractQuantityFromRequest(requestBody) {
        if (window.__wscDebugMode) console.log('ðŸ”§ Extracting quantity from request body:', requestBody);

        try {
            // If it's FormData, iterate through it
            if (requestBody instanceof FormData) {
                for (const [key, value] of requestBody.entries()) {
                    if (window.__wscDebugMode) console.log('ðŸ”§ FormData entry:', key, '=', value);
                    if (key.includes('[quantity]')) {
                        const qty = parseInt(value, 10);
                        if (!isNaN(qty) && qty > 0) {
                            if (window.__wscDebugMode) console.log('ðŸ”§ Found quantity in FormData:', qty);
                            return qty;
                        }
                    }
                }
            }

            // If it's a string (URL-encoded), parse it
            if (typeof requestBody === 'string') {
                const params = new URLSearchParams(requestBody);
                for (const [key, value] of params.entries()) {
                    if (window.__wscDebugMode) console.log('ðŸ”§ URLSearchParams entry:', key, '=', value);
                    if (key.includes('[quantity]')) {
                        const qty = parseInt(value, 10);
                        if (!isNaN(qty) && qty > 0) {
                            if (window.__wscDebugMode) console.log('ðŸ”§ Found quantity in URLSearchParams:', qty);
                            return qty;
                        }
                    }
                }
            }
        } catch (e) {
            if (window.__wscDebugMode) console.warn('ðŸ”§ Error extracting quantity:', e);
        }

        if (window.__wscDebugMode) console.log('ðŸ”§ No quantity found, defaulting to 1');
        return 1; // Default quantity
    }

    /**
     * Install AJAX interceptor for add-to-cart requests
     */
    function installAjaxInterceptor() {
        // Store request body for fetch requests
        let lastRequestBody = null;

        // Intercept fetch()
        const originalFetch = window.fetch;
        if (typeof originalFetch === 'function') {
            window.fetch = async function(...args) {
                const url = typeof args[0] === 'string' ? args[0] : (args[0] && args[0].url) || '';

                // Store request body if it's an add-to-cart request
                if (url.includes('checkout/line-item/add') && args[1] && args[1].body) {
                    lastRequestBody = args[1].body;
                    if (window.__wscDebugMode) console.log('ðŸ”§ Stored fetch request body:', lastRequestBody);
                }

                const response = await originalFetch(...args);

                if (url.includes('checkout/line-item/add') && response && response.ok) {
                    if (window.__wscDebugMode) console.log('ðŸ”§ AJAX add-to-cart detected (fetch)! URL:', url);

                    // Use last clicked product data
                    if (lastClickedProduct) {
                        // Extract quantity from request body
                        const quantity = extractQuantityFromRequest(lastRequestBody);

                        const item = Object.assign({}, lastClickedProduct, { quantity: quantity });

                        if (window.__wscDebugMode) console.log('ðŸ”§ Pushing add_to_cart event with data:', item);

                        pushEvent('add_to_cart', {
                            currency: item.currency || getCurrency(),
                            value: calculateValue(item, quantity),
                            items: [item]
                        });

                        if (window.__wscDebugMode) console.log('âœ… add_to_cart event pushed successfully!');

                        // Reset
                        lastRequestBody = null;
                    } else {
                        if (window.__wscDebugMode) console.warn('ðŸ”§ No last clicked product stored!');
                    }
                }

                return response;
            };
        }

        // Intercept XMLHttpRequest
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            this.__wscUrl = url;
            return originalOpen.call(this, method, url, ...rest);
        };

        const originalSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function(body) {
            // Store request body for add-to-cart requests
            const url = this.__wscUrl || '';
            if (url.includes('checkout/line-item/add')) {
                this.__wscRequestBody = body;
                if (window.__wscDebugMode) console.log('ðŸ”§ Stored XMLHttpRequest body:', body);
            }

            this.addEventListener('load', function() {
                const url = this.__wscUrl || '';
                if (url.includes('checkout/line-item/add') && this.status >= 200 && this.status < 300) {
                    if (window.__wscDebugMode) console.log('ðŸ”§ AJAX add-to-cart detected (XMLHttpRequest)! URL:', url);

                    // Use last clicked product data
                    if (lastClickedProduct) {
                        // Extract quantity from request body
                        const quantity = extractQuantityFromRequest(this.__wscRequestBody);

                        const item = Object.assign({}, lastClickedProduct, { quantity: quantity });

                        if (window.__wscDebugMode) console.log('ðŸ”§ Pushing add_to_cart event with data:', item);

                        pushEvent('add_to_cart', {
                            currency: item.currency || getCurrency(),
                            value: calculateValue(item, quantity),
                            items: [item]
                        });

                        if (window.__wscDebugMode) console.log('âœ… add_to_cart event pushed successfully!');
                    } else {
                        if (window.__wscDebugMode) console.warn('ðŸ”§ No last clicked product stored!');
                    }
                }
            });
            return originalSend.call(this, body);
        };
    }

    /**
     * Register remove-from-cart listener
     */
    function registerRemoveFromCartListener() {
        document.addEventListener('submit', function(event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;

            const action = form.getAttribute('action') || '';
            if (!action.includes('checkout/line-item/delete') && !action.includes('line-item/remove')) return;

            const productData = getProductDataFromElement(form);
            if (!productData || !productData.item_id) return;

            // Get quantity from form
            const formData = new FormData(form);
            let quantity = 1;
            for (const [key, value] of formData.entries()) {
                if (key.endsWith('[quantity]')) {
                    const qty = parseFloat(String(value));
                    if (!Number.isNaN(qty)) {
                        quantity = qty;
                    }
                }
            }

            const item = Object.assign({}, productData, { quantity });

            pushEvent('remove_from_cart', {
                currency: item.currency || getCurrency(),
                value: calculateValue(item, quantity),
                items: [item]
            });
        }, true);
    }

    /**
     * Register wishlist listener
     */
    function registerWishlistListener() {
        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            const trigger = target.closest(
                '[data-wishlist-add], [data-wishlist-add-id], [data-add-to-wishlist], .product-wishlist-action, .wishlist-add'
            );
            if (!trigger) return;

            const productData = getProductDataFromElement(trigger);
            if (!productData || !productData.item_id) return;

            const item = Object.assign({}, productData, { quantity: 1 });

            pushEvent('add_to_wishlist', {
                currency: item.currency || getCurrency(),
                value: calculateValue(item, 1),
                items: [item]
            });
        });
    }

    /**
     * Register select_item listener (product click in listing)
     */
    function registerSelectItemListener() {
        if (window.__wscDebugMode) console.log('ðŸ”§ Registering select_item listener');

        document.addEventListener('click', function(event) {
            const target = event.target instanceof Element ? event.target : null;
            if (!target) return;

            // Find product link (but NOT the add-to-cart button!)
            const productLink = target.closest('.product-name, .product-image-link, a.product-link, [data-product-link]');
            if (!productLink) return;

            // Skip if it's an add-to-cart button
            if (target.closest('.btn-buy, [data-add-to-cart]')) return;

            if (window.__wscDebugMode) console.log('ðŸ”§ Product link clicked:', productLink);

            const productData = getProductDataFromElement(productLink);
            if (!productData || !productData.item_id) {
                if (window.__wscDebugMode) console.warn('ðŸ”§ No product data found for select_item');
                return;
            }

            if (window.__wscDebugMode) console.log('ðŸ”§ Pushing select_item event with data:', productData);

            pushEvent('select_item', {
                item_list_id: productData.item_list_id || 'unknown',
                item_list_name: productData.item_list_name || 'Unknown List',
                items: [productData]
            });

            if (window.__wscDebugMode) console.log('âœ… select_item event pushed successfully!');
        }, true);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM is still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__wscDebugMode) console.log('ðŸ”§ DOMContentLoaded fired, initializing listeners...');
            registerAddToCartListener();
            installAjaxInterceptor();
            registerRemoveFromCartListener();
            registerWishlistListener();
            registerSelectItemListener();
            if (window.__wscDebugMode) console.log('âœ… All WSC DataLayer listeners registered successfully!');
        });
    } else {
        if (window.__wscDebugMode) console.log('ðŸ”§ DOM already loaded, initializing listeners immediately...');
        registerAddToCartListener();
        installAjaxInterceptor();
        registerRemoveFromCartListener();
        registerWishlistListener();
        registerSelectItemListener();
        if (window.__wscDebugMode) console.log('âœ… All WSC DataLayer listeners registered successfully!');
    }
})();
</script>
